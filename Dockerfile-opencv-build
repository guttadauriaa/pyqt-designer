# Build stage
FROM python:3.11-slim AS builder

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential cmake git pkg-config libgtk-3-dev \
    libavcodec-dev libavformat-dev libswscale-dev libv4l-dev \
    libxvidcore-dev libx264-dev libjpeg-dev libpng-dev libtiff-dev \
    libopenblas-dev liblapack-dev \
    gfortran python3-dev \
    qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools libqt5opengl5-dev \
    && rm -rf /var/lib/apt/lists/*

RUN pip install numpy

# Set version and working directory
ARG OPENCV_VERSION=4.10.0
WORKDIR /opt/opencv

# Download OpenCV and opencv_contrib
RUN git clone --branch ${OPENCV_VERSION} --depth 1 https://github.com/opencv/opencv.git && \
    git clone --branch ${OPENCV_VERSION} --depth 1 https://github.com/opencv/opencv_contrib.git

# Build and install to a custom prefix
RUN mkdir -p opencv/build && \
    cd opencv/build && \
    cmake -D CMAKE_BUILD_TYPE=RELEASE \
          -D CMAKE_INSTALL_PREFIX=/usr/local \
          -D OPENCV_ENABLE_NONFREE=ON \
          -D OPENCV_EXTRA_MODULES_PATH=/opt/opencv/opencv_contrib/modules \
          -D PYTHON3_EXECUTABLE=$(which python3) \
          -D PYTHON3_INCLUDE_DIR=$(python3 -c "from distutils.sysconfig import get_python_inc; print(get_python_inc())") \
          -D PYTHON3_PACKAGES_PATH=/usr/local/lib/python3.11/site-packages \
          -D BUILD_opencv_python3=ON \
          -D WITH_QT=ON \
          -D WITH_OPENGL=ON \
          # for debian 13
          -D WITH_TBB=OFF \
          -D WITH_OPENBLAS=ON \
          # end for debian 13
          -D BUILD_EXAMPLES=OFF \
          -D BUILD_TESTS=OFF \
          -D BUILD_PERF_TESTS=OFF \
          .. && \
    make -j$(nproc) && \
    make install

# Runtime stage
FROM python:3.11-slim

# Copy the installed OpenCV libraries and Python bindings
COPY --from=builder /usr/local /usr/local

# Where is the cv2 dynamic library file
RUN find /usr/local -name "cv2*.so"

# OpenCV installe souvent dans cv2/python-3.11/
# Il faut ajuster le PYTHONPATH pour trouver le fichier cv2*.so
ENV PYTHONPATH="/usr/local/lib/python3.13/site-packages/cv2/python-3.13:/usr/lib/python3/dist-packages${PYTHONPATH:+:$PYTHONPATH}"

# Install runtime Qt5 and GUI libraries
RUN apt-get update && apt-get install -y \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libxfixes3 \
    libdbus-1-3 \
    libgl1 \
    libglx-mesa0 \
    libegl1 \
    libwayland-client0 \
    libwayland-cursor0 \
    libwayland-egl1 \
    libxkbcommon-x11-0 \
    libxcb-cursor0 \
    libxcb-xinerama0 \
    libqt5core5t64 \
    libqt5gui5t64 \
    libqt5opengl5t64 \
    libqt5widgets5t64 \
    libavcodec61 \
    libavformat61 \
    libswscale8 \
    libavutil59 \
    && rm -rf /var/lib/apt/lists/*

# Update the library cache
RUN ldconfig

# Évite les interactions lors de l'installation
ENV DEBIAN_FRONTEND=noninteractive

# Installation des dépendances système pour Qt, Wayland et OpenGL
RUN apt-get update && apt-get install -y \
    qttools5-dev-tools \
    qt5-qmake \
    pyqt5-dev-tools \
    python3-pip \
    libgl1 \
    libglx-mesa0 \
    libegl1 \
    libdbus-1-3 \
    libglib2.0-0 \
    libgomp1 \
    libwayland-client0 \
    libwayland-cursor0 \
    libwayland-egl1 \
    libxkbcommon-x11-0 \
    libxcb-cursor0 \
    libqt5gui5t64 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    python3-pyqt5 \
    python3-pyqt5.sip \
    && rm -rf /var/lib/apt/lists/*

RUN ldconfig

# Installation des bibliothèques Python scientifiques
RUN pip install --no-cache-dir \
    matplotlib \
    numpy \
    scipy \
    scikit-learn \
    scikit-image
    # inutile si opencv est compilé
    #opencv-python

# Inutile si opencv est compilé
#RUN apt-get update && apt-get install -y \
#    python3-opencv \
#    && rm -rf /var/lib/apt/lists/*

# Configuration pour Wayland
#ENV QT_QPA_PLATFORM=wayland  # pas si l'on veut l'utiliser avec X11
ENV XDG_RUNTIME_DIR=/tmp/runtime-dir

WORKDIR /app

# Lancer bash par défaut (ou peut être écrasé à l'exécution)
CMD ["bash"]

